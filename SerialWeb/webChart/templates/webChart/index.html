<!DOCTYPE html>
{% load static %}
<html>
<head>
    <meta charset="utf-8">
    <title>串口数据显示</title>
    <!-- 引入 ECharts 文件 -->
    <link rel="stylesheet" type="text/css" href="{% static 'webChart/bootstrap.min.css' %}" /> 
    <script type="text/javascript" src="{% static 'webChart/jquery-2.2.4.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'webChart/bootstrap.min.js' %}"></script>
    <script src="{% static 'webChart/echarts.min.js' %}"></script>
    <style type="text/css">
    div.top {
        position: absolute;
        left: 30px;
        right: 30px;
        top: 10px;
        height: 60px;
        padding-left: 30px;
        padding-top: 10px;
    }
    div.chart {
        position: absolute;
        left: 0px;
        right: 0px;
        bottom: 0px;
        top: 60px;
        width: 100%;
    }
    html, body{
        height: 100%;
        width: 100%;
    }
    </style>
    <script type="text/javascript">
    function getData(msg) {
        var date = new Date(msg.substring(msg.indexOf('[') + 1, msg.indexOf(']')));
        var value = msg.substring(msg.indexOf(']') + 1);
        return {name: date.toString(),
            value: [date, value]}
    }

    function getDataOption(dataList){
        var data = [];
        for (var i = 0; i < dataList.length; i++){
            data.push({
                data: dataList[i].data
            });
        }
        return data;
    }

    function setOption(dataList){
        var color = ['#ff99ff', '#ff0000', '#0000cc', '#00ff99', '#cc9900', '#3366cc'];
        var legend = [];
        for (var i = 0; i < dataList.length; i++){
            legend.push(dataList[i].name);
        }
        var data = [];
        for (var i = 0; i < dataList.length; i++){
            data.push({
                name: dataList[i].name,
                type: 'line',
                showSymbol: false,
            });
        }
        option = {
            color: color,
            title: {
                text: '串口数据图'
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                }
            },
            xAxis: {
                type: 'time',
                splitLine: {
                    show: false
                },
            },
            yAxis: {
                type: 'value',
                boundaryGap: [0, '30%'],
            },
            legend: {
                data: legend
            },
            series: data
        };

        return option;
    }

    function drawChart(dataList){
        // 基于准备好的dom，初始化echarts实例
        var myChart = echarts.init(document.getElementById('main'));

        // 指定图表的配置项和数据
        var option = setOption(dataList);

        // 使用刚指定的配置项和数据显示图表。
        myChart.setOption(option);
        return myChart;
    }

    function getMsg(chart, button, dataList){
        setInterval(function(){
            $.ajax({url: 'http://' + window.location.host + "/json",
                data: {func: "read", name:button.value},
                success: function(result){
                    if (result.flag == false){
                        alert("读取失败");
                        return;
                    }
                    if (result.msg.length == 0)
                        return;
                    var data = getData(result.msg);
                    for (var i = 0; i < dataList.length; i++){
                        if (dataList[i].name == button.value){
                            dataList[i].data.push(data);
                        }
                    }
                    var option = getDataOption(dataList);
                    chart.setOption({
                        series: option
                    });
                }
            })
        }, 1000);
    }

    function checkOpenList(chart, dataList){
        $.ajax({url: 'http://' + window.location.host + "/json",
            data: {func: "checkOpen", name: ""},
            success: function(result){
                if (result.flag == false)
                    return;
                var buttonList = $("button.com");
                for (var j = 0; j < buttonList.length; j ++){
                    var button = buttonList[j];
                    for (var i = 0; i < result.openList.length; i++){
                        if (button.value == result.openList[i]){
                            $(button).removeClass('btn-success').addClass('btn-danger');
                            button.innerHTML = "关闭" + button.value;
                        }
                    }
                }
                for (var i = 0; i < result.occupy.length; i++){
                    $(".top")[0].innerHTML += "<button class='btn btn-default' disabled=true>" + result.occupy[i] + "被占用</button>"
                }
                $("button.com").on('click', function(){
                    var btn = $(this)[0]
                    if ($(btn).hasClass('btn-success')){
                        $.ajax({url: 'http://' + window.location.host + "/json",
                            data: {func: "open", name:btn.value},
                            success: function(result){
                                if (result.flag == false){
                                    alert("打开失败");
                                    return;
                                }
                                btn.innerHTML = "关闭" + btn.value;
                                $(btn).removeClass('btn-success').addClass('btn-danger');
                                getMsg(chart, btn, dataList);
                            }
                        });
                    }
                    else if ($(btn).hasClass('btn-danger')){
                        $.ajax({url: 'http://' + window.location.host + "/json",
                            data: {func:"close", name:btn.value},
                            success: function(result){
                                if (result.flag == false){
                                    alert("关闭失败");
                                    return;
                                }
                                btn.innerHTML = "打开" + btn.value;
                                $(btn).removeClass('btn-danger').addClass('btn-success');
                            }
                        });
                    }
                });
                checkOpenedCom(chart, dataList);
            }
        });
    }

    function checkOpenedCom(chart, dataList){
        var openList = $("button").filter(".com.btn-danger");
        for (var i = 0; i < openList.length; i++){
            getMsg(chart, openList[i], dataList);
        }
    }

    $(document).ready(function(){
        var dataList = [];
        for (var i = 0; i < $("button.com").length; i++){
            dataList.push({'name': $("button.com")[i].value, 'data':[]});
        }
        var chart = drawChart(dataList);
        checkOpenList(chart, dataList);
    });
    </script>
</head>
<body>
    <div class="top">
        {% for item in list %}
            {% for port, open in item.items %}
                <button class="com btn btn-success" value="{{port}}">打开{{port}}</button>
            {% endfor %}
        {% endfor %}
        {% for item in list %} {% for port, open in item.items %}
            <button class="download btn btn-primary">下载{{port}}数据</button>
        {% endfor %} {% endfor %}
    </div>
    <!-- 为 ECharts 准备一个具备大小（宽高）的 DOM -->
    <div class="chart" id="main"></div>
</body>
</html>